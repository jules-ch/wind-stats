from pathlib import Path

import httpretty
import numpy as np
from numpy.testing import assert_array_equal

from wind_stats.gwa_reader import GWAReader, get_gwc_data, get_weibull_parameters

test_file = Path(__file__).parent / "gwa3_gwc_test_file.lib"


def test_get_weibull_parameters():
    reader = GWAReader()
    dataset = reader.load(test_file.open())
    A, k, _ = get_weibull_parameters(dataset, [0] * 12, 50)
    assert A, k


@httpretty.activate
def test_get_gwa_data():

    latitude = 49.056
    longitude = 0.667

    httpretty.register_uri(
        httpretty.GET,
        uri=f"https://globalwindatlas.info/api/gwa/custom/Lib/?lat={latitude}&long={longitude}",
        status=200,
        content_type="application/octet-stream",
        body=test_file.read_bytes(),
    )

    dataset = get_gwc_data(latitude, longitude)
    assert dataset.coordinates == (latitude, longitude)


class TestGWAReader:
    def test_loads(self):
        reader = GWAReader()
        reader.loads(test_file.read_bytes())

    def test_load(self):
        reader = GWAReader()
        dataset = reader.load(test_file.open())
        assert dataset
        assert dataset.coordinates == (49.056, 0.667)
        assert_array_equal(
            dataset.A,
            np.array(
                [
                    [
                        [
                            6.01,
                            6.65,
                            6.43,
                            6.41,
                            6.44,
                            6.88,
                            8.67,
                            11.05,
                            9.99,
                            8.93,
                            6.81,
                            6.2,
                        ],
                        [
                            7.15,
                            7.88,
                            7.6,
                            7.61,
                            7.66,
                            8.16,
                            10.24,
                            12.86,
                            11.69,
                            10.51,
                            8.12,
                            7.38,
                        ],
                        [
                            7.81,
                            8.58,
                            8.27,
                            8.29,
                            8.37,
                            8.89,
                            11.12,
                            13.77,
                            12.58,
                            11.37,
                            8.89,
                            8.07,
                        ],
                        [
                            8.39,
                            9.35,
                            9.27,
                            9.37,
                            9.41,
                            9.7,
                            11.8,
                            15.2,
                            14.0,
                            12.59,
                            10.26,
                            8.4,
                        ],
                        [
                            8.75,
                            9.72,
                            9.83,
                            10.09,
                            9.81,
                            9.89,
                            11.83,
                            16.04,
                            14.94,
                            13.36,
                            10.43,
                            8.98,
                        ],
                    ],
                    [
                        [
                            4.15,
                            4.79,
                            4.45,
                            4.45,
                            4.5,
                            5.17,
                            7.04,
                            7.64,
                            6.94,
                            5.68,
                            4.66,
                            4.15,
                        ],
                        [
                            5.91,
                            6.71,
                            6.23,
                            6.32,
                            6.41,
                            7.28,
                            9.52,
                            10.21,
                            9.44,
                            7.95,
                            6.61,
                            5.96,
                        ],
                        [
                            7.1,
                            7.98,
                            7.39,
                            7.58,
                            7.7,
                            8.67,
                            10.98,
                            11.68,
                            10.97,
                            9.42,
                            7.93,
                            7.21,
                        ],
                        [
                            8.09,
                            9.42,
                            8.8,
                            9.23,
                            8.91,
                            9.84,
                            12.26,
                            13.58,
                            12.52,
                            11.06,
                            9.03,
                            8.28,
                        ],
                        [
                            8.99,
                            10.42,
                            9.9,
                            10.35,
                            9.71,
                            10.44,
                            12.39,
                            14.98,
                            13.72,
                            11.89,
                            10.4,
                            8.9,
                        ],
                    ],
                    [
                        [
                            3.67,
                            4.22,
                            3.92,
                            3.93,
                            3.98,
                            4.56,
                            6.18,
                            6.69,
                            6.09,
                            5.01,
                            4.11,
                            3.67,
                        ],
                        [
                            5.44,
                            6.17,
                            5.72,
                            5.82,
                            5.89,
                            6.69,
                            8.75,
                            9.39,
                            8.68,
                            7.3,
                            6.08,
                            5.48,
                        ],
                        [
                            6.56,
                            7.37,
                            6.83,
                            7.0,
                            7.11,
                            8.0,
                            10.19,
                            10.85,
                            10.16,
                            8.71,
                            7.32,
                            6.65,
                        ],
                        [
                            7.47,
                            8.68,
                            8.13,
                            8.51,
                            8.22,
                            9.07,
                            11.42,
                            12.68,
                            11.64,
                            10.4,
                            8.33,
                            7.64,
                        ],
                        [
                            8.28,
                            9.6,
                            9.13,
                            9.52,
                            8.96,
                            9.62,
                            11.57,
                            14.03,
                            12.79,
                            11.04,
                            9.58,
                            8.19,
                        ],
                    ],
                    [
                        [
                            3.17,
                            3.19,
                            3.15,
                            3.19,
                            3.22,
                            3.68,
                            4.72,
                            5.17,
                            4.76,
                            3.96,
                            3.13,
                            2.8,
                        ],
                        [
                            5.11,
                            5.12,
                            5.03,
                            5.15,
                            5.21,
                            5.92,
                            7.38,
                            8.02,
                            7.47,
                            6.36,
                            5.11,
                            4.58,
                        ],
                        [
                            6.22,
                            6.23,
                            6.11,
                            6.29,
                            6.36,
                            7.21,
                            8.79,
                            9.47,
                            8.92,
                            7.71,
                            6.28,
                            5.65,
                        ],
                        [
                            7.06,
                            7.39,
                            7.28,
                            7.56,
                            7.29,
                            8.36,
                            9.85,
                            11.2,
                            10.5,
                            9.22,
                            7.4,
                            6.6,
                        ],
                        [
                            7.63,
                            8.14,
                            8.26,
                            8.55,
                            7.89,
                            8.81,
                            10.19,
                            12.51,
                            11.59,
                            9.98,
                            8.14,
                            7.17,
                        ],
                    ],
                    [
                        [
                            2.16,
                            2.18,
                            2.11,
                            2.14,
                            2.22,
                            2.63,
                            3.54,
                            3.42,
                            3.12,
                            2.5,
                            2.14,
                            1.9,
                        ],
                        [
                            4.25,
                            4.27,
                            4.12,
                            4.21,
                            4.37,
                            5.17,
                            6.73,
                            6.52,
                            6.02,
                            4.94,
                            4.21,
                            3.77,
                        ],
                        [
                            5.37,
                            5.38,
                            5.2,
                            5.34,
                            5.53,
                            6.53,
                            8.27,
                            8.05,
                            7.48,
                            6.27,
                            5.33,
                            4.82,
                        ],
                        [
                            6.19,
                            6.47,
                            6.28,
                            6.64,
                            6.43,
                            7.46,
                            9.56,
                            9.56,
                            8.9,
                            7.35,
                            6.07,
                            5.71,
                        ],
                        [
                            6.8,
                            7.24,
                            7.12,
                            7.38,
                            7.09,
                            7.85,
                            10.33,
                            10.73,
                            9.8,
                            8.16,
                            6.84,
                            6.25,
                        ],
                    ],
                ]
            ),
        )
